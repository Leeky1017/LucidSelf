# 启动性与回归基线 Design

## 设计意图
本设计文档用于固定「启动性与回归基线」在规格层面的设计立场：契约、数据完整性、门禁与审计。禁止写实现细节。

## 依赖关系
- 上游依赖：`observability-slos`

## 必备标识符（最小集）
- `version_id`

## 关键决策（非实现）
- 所有用户可见结论必须可追溯到 `version_id` 与证据链（如适用）。
- 门禁失败必须阻断晋级，并产出可行动的整改项清单。
- 可观测与审计字段是契约的一部分，必须被一致执行。

## 数据完整性语义（规格层）

### 引用可解析性（MUST）
- `RegressionSuiteBaseline.version_id`、`BlockRecord.version_id`、`VersionLinkReport.version_id` MUST 非空且可用于追溯（可解析性由版本体系定义）。
- `reason_code` 若存在 MUST 可解析到契约枚举 `rejection_reasons[*].code`；不可解析 MUST 失败并阻断。

### 幂等 / 去重（MUST）
- 系统 MUST 定义确定性的去重键，以避免重复记录造成的门禁漂移；去重键仅允许由契约字段构成。
- 约定的最小去重键（规格级语义）：
  - 启动检查项：`check_id`
  - 回归套件基线：`suite_id`
  - 阻断记录：`block_id`
  - 版本关联报告：`report_id`
- 对相同去重键的重复提交：
  - 若提交内容等价 SHALL 视为幂等成功。
  - 若提交内容不等价 MUST 视为冲突并拒绝（`VALIDATION_FAILED`）。

### 冲突处理（MUST）
- 冲突判定与拒绝原因 MUST 确定性一致。
- 冲突 MUST 记录审计事件。

## 运行时确定性与偏差口径（规格层）

### 确定性边界（SHALL）
- 在相同输入与相同 `version_id` 下重复执行启动检查与回归基线时：
  - 通过/失败判定与失败原因代码 SHALL 等价。
  - 阻断记录（若触发）在本 spec 定义的等价范围内 SHALL 等价。

### 偏差检测与解释（MUST）
- 系统 MUST 能检测回归基线漂移（例如同一版本下基线列表/阈值发生变化）。
- 偏差事件 MUST 至少包含：`version_id`、偏差类型、影响面与可行动摘要。

## 失败处理策略与信号产物（规格层）

### 策略（最小）
- 启动检查失败或回归基线失败 MUST 生成阻断记录（`BlockRecord`）并阻断晋级/发布。
- 失败原因 MUST 可行动（最小：失败类别 + 失败原因代码 + 关联版本）。

## 发布策略（Rollout）与回滚触发（规格层）

### 分阶段 rollout（最小）
- **Shadow**：并行运行启动检查与回归套件，不影响对外发布，用于验证基线稳定性与执行成本。
- **Canary**：对小范围版本/服务启用阻断策略，观察误报率与执行开销。
- **Gradual**：逐步扩大范围直至全量；扩容步骤 MUST 可审计。

### 回滚触发条件（MUST）
- 误报导致大面积阻断 MUST 触发回滚或基线调整（需可审计）。
- 回归执行不可用导致无法判定 MUST 触发阻断并停止晋级。

## Top 风险与缓解（写入门禁/证据/回退）

1) **回归基线缺失或不可执行**  
   - 缓解：RegressionSuiteBaseline 数据字典与验收口径（本 spec）+ Gate-1 阻断策略（`acceptance.md`）

2) **误报阻断**：测试不稳定导致发布被错误阻断  
   - 缓解：分阶段 rollout（本文件）+ 失败原因可行动记录（本文件/契约）

3) **不可追溯**：回归结果无法关联到 `version_id`  
   - 缓解：VersionLinkReport 与必填 `version_id`（契约/数据字典）

4) **执行成本失控**：回归耗时/资源异常上升  
   - 缓解：性能/成本阈值（`performance.md`/`cost.md`）+ 指标监控（`observability.md`）

5) **审计缺失**：阻断缺少证据链  
   - 缓解：审计字段与导出（`audit_log.md`/`compliance.md`）+ BlockRecord

## 非目标
- 不规定具体存储/消息队列/监控方案。
- 不包含任何代码路径、伪代码或接口实现。
