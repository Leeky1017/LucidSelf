# 语料治理 Design

## 设计意图
本设计文档用于固定「语料治理」在规格层面的设计立场：契约、数据完整性、门禁与审计。禁止写实现细节。

## 依赖关系
- 上游依赖：无

## 必备标识符（最小集）
- `asset_id`, `corpus_release_id`, `version_id`

## 关键决策（非实现）
- 所有用户可见结论必须可追溯到 `version_id` 与证据链（如适用）。
- 门禁失败必须阻断晋级，并产出可行动的整改项清单。
- 可观测与审计字段是契约的一部分，必须被一致执行。

## 数据完整性语义（规格层）

### 引用可解析性（MUST）
- `AssetRegistration.license_id` MUST 可解析到 `LicenseConstraint.license_id`；不可解析 MUST 失败并阻断。
- `LineageRecord.derived_from[*]` 若存在 MUST 可解析到已登记的 `asset_id`；不可解析 MUST 失败并阻断。
- `RetirementRecord.asset_id` MUST 可解析到已登记的 `asset_id`；不可解析 MUST 失败并阻断。

### 幂等 / 去重（MUST）
- 系统 MUST 定义确定性的去重键，以避免资产治理记录重复写入导致血缘/许可漂移；去重键仅允许由契约字段构成。
- 约定的最小去重键（规格级语义）：
  - 资产登记：`asset_id`
  - 许可约束：`license_id`
  - 血缘记录：`asset_id` + `version_id`
  - 退役记录：`retirement_id`
- 对相同去重键的重复提交：
  - 若提交内容等价 SHALL 视为幂等成功。
  - 若提交内容不等价 MUST 视为冲突并拒绝（`VALIDATION_FAILED`）。

### 冲突处理（MUST）
- 冲突判定与拒绝原因 MUST 确定性一致。
- 冲突/例外处置结果 MUST 可审计（包括批准记录的存在性要求，处置流程细节由相关下游 spec 约束）。

## 运行时确定性与偏差口径（规格层）

### 确定性边界（SHALL）
- 在相同输入（含 `asset_id`/`corpus_release_id`/`version_id`）与相同许可/血缘语义下重复执行时：
  - 许可校验结论与拒绝原因代码 SHALL 等价。
  - 血缘解析与退役判定 SHALL 等价。

### 偏差检测与解释（MUST）
- 系统 MUST 能检测语料治理契约漂移（例如同一资产在同一发布版本下许可/血缘不一致）。
- 偏差事件 MUST 至少包含：`asset_id`、`corpus_release_id`、偏差类型与可行动摘要。

## 失败处理策略与信号产物（规格层）

### 策略（最小）
- 许可违规 MUST 阻断使用/发布并生成审计记录（`LICENSE_VIOLATION`）。
- 血缘不可解析或资产未登记 MUST 阻断并返回确定性的拒绝原因。

## 发布策略（Rollout）与回滚触发（规格层）

### 分阶段 rollout（最小）
- **Shadow**：对语料使用路径先记录许可校验与血缘解析结果，不影响现有流程，用于验证覆盖率与误报率。
- **Canary**：对小范围语料发布启用阻断策略，观察许可违规与血缘不可解析率。
- **Gradual**：逐步扩大范围直至全量；扩容步骤 MUST 可审计。

### 回滚触发条件（MUST）
- 发现许可误判导致合法资产被阻断 MUST 触发回滚或规则修订（需可审计）。
- 发现许可违规或血缘不可追溯导致合规风险 MUST 触发阻断并停止发布。

## Top 风险与缓解（写入门禁/证据/回退）

1) **许可违规导致合规风险**  
   - 缓解：许可校验阻断（本文件/契约）+ 违规审计与留存（`audit_log.md`/`compliance.md`）

2) **血缘不可追溯**：无法回到 `corpus_release_id`  
   - 缓解：LineageRecord 字段约束与引用可解析性（契约/数据字典）

3) **资产登记缺失**：下游引用无法解析  
   - 缓解：资产登记必填字段与唯一性（数据字典）+ 阻断策略（`acceptance.md`）

4) **误报阻断影响发布节奏**  
   - 缓解：分阶段 rollout（本文件）+ 回滚触发条件（本文件）

5) **审计缺失导致不可追责**  
   - 缓解：审计字段与导出（`audit_log.md`）+ 合规留存（`compliance.md`）

## 非目标
- 不规定具体存储/消息队列/监控方案。
- 不包含任何代码路径、伪代码或接口实现。
