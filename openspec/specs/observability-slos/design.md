# 可观测性与SLO Design

## 设计意图
本设计文档用于固定「可观测性与SLO」在规格层面的设计立场：契约、数据完整性、门禁与审计。禁止写实现细节。

## 依赖关系
- 上游依赖：无

## 必备标识符（最小集）
- `request_id`, `trace_id`, `version_id`, `engine_id`, `user_id`

## 关键决策（非实现）
- 所有用户可见结论必须可追溯到 `version_id` 与证据链（如适用）。
- 门禁失败必须阻断晋级，并产出可行动的整改项清单。
- 可观测与审计字段是契约的一部分，必须被一致执行。

## 数据完整性语义（规格层）

### 引用可解析性（MUST）
- `AlertRule.slo_id` 若提供 MUST 可解析到 `SLODefinition.slo_id`；不可解析 MUST 失败并阻断。
- 观测字段（如 `trace_id/request_id/version_id/engine_id/user_id`）若被声明为必填，则缺失 MUST 触发确定性的拒绝原因。

### 幂等 / 去重（MUST）
- 系统 MUST 定义确定性的去重键，以避免重复定义造成的观测漂移；去重键仅允许由契约字段构成。
- 约定的最小去重键（规格级语义）：
  - 指标定义：`metric_name`
  - 日志字段 schema：`schema_id` + `schema_version`
  - SLO 定义：`slo_id`
  - 告警规则：`rule_id`
- 对相同去重键的重复提交：
  - 若提交内容等价（在本 spec 定义的等价范围内）SHALL 视为幂等成功。
  - 若提交内容不等价 MUST 视为冲突并拒绝（例如 `VALIDATION_FAILED`）。

### 冲突处理（MUST）
- 冲突的判定与拒绝原因 MUST 可复现、确定性（相同输入得到相同拒绝代码）。
- 冲突 MUST 记录审计事件，且审计记录必须遵循最小化/脱敏原则。

## 运行时确定性与偏差口径（规格层）

### 确定性边界（SHALL）
- 在相同输入（含 `request_id`/`trace_id`/`version_id`/`engine_id`/`user_id`）与相同观测语义（同一版本的观测字段/命名规范）下重复执行时：
  - 必须产出的观测字段（logs/traces 的必填字段集合）SHALL 一致。
  - 观测缺失/非法的拒绝原因代码 SHALL 确定性一致。

### 等价范围（最小）
- 允许的非确定性字段（若存在）MUST 被显式标注并可审计，例如时间戳与系统生成的 span 标识。
- 除显式允许项外，观测产物差异 MUST 视为偏差并可审计。

### 偏差检测与解释（MUST）
- 系统 MUST 能检测关键观测字段缺失/漂移（例如必填字段缺失、命名规范不一致、标签违规）。
- 偏差事件 MUST 至少包含：`request_id`、`trace_id`（若适用）、`version_id`、偏差类型与影响面。

## 失败处理策略与信号产物（规格层）

### 失败分类（最小）
- **拒绝（DENY）**：必填标识符缺失/非法、命名规范不满足、标签违规等（通常不可重试）。
- **阻断（BLOCK）**：SLO/告警规则不可执行或关键审计不可用导致无法满足 Gate-0（需要人工整改或回滚）。
- **内部错误（INTERNAL_ERROR）**：非预期异常（可能可重试）。

### 策略（MUST/SHALL）
- 对于命名/标签违规等可判定问题，系统 MUST 返回确定性的拒绝原因代码并形成审计记录。
- 对于阻断场景（例如审计不可用、SLO 规则缺失导致无法判定），系统 MUST 阻断晋级/发布并产出可行动整改线索。
- 对于内部错误，系统 SHOULD 标记 `retryable=true` 并允许上游按策略重试；重复失败 MUST 触发阻断信号。

## 发布策略（Rollout）与回滚触发（规格层）

### 分阶段 rollout（最小）
- **Shadow**：并行产出观测字段与 SLO 评估结果，不影响对外行为，用于验证覆盖率与一致性。
- **Canary**：对一小部分流量/路径启用严格字段要求与告警规则，观察误报率与性能开销。
- **Gradual**：逐步扩大范围直至全量；扩容步骤 MUST 可审计（记录 rollout 阶段与范围）。

### 回滚触发条件（MUST）
- 观测开销导致核心路径延迟超过阈值 MUST 触发回滚或降级。
- 高基数时间序列异常抬升 MUST 触发回滚或标签治理整改（见 `data_dictionary.md`）。
- logs/traces 出现敏感信息泄露风险 MUST 触发回滚并启动合规处置流程。

## Top 风险与缓解（写入门禁/证据/回退）

1) **关键字段缺失导致不可定位**：`request_id/trace_id/version_id` 不完整  
   - 缓解：必填字段规范与偏差检测（本文件）+ Gate-0 阻断策略（`acceptance.md`）

2) **高基数指标导致成本失控**：标签违规引入时间序列爆炸  
   - 缓解：标签约束（`observability.md`/`data_dictionary.md`）+ 成本阈值告警（`cost.md`）

3) **日志泄露敏感信息**：把 token/自由文本写入日志或审计  
   - 缓解：脱敏/最小化规范（`audit_log.md`/`security.md`）+ 合规留存与导出约束（`compliance.md`）

4) **SLO/告警口径不可执行**：阈值/窗口/定义不明确导致无法判定  
   - 缓解：SLO/告警数据字典与引用可解析性（`data_dictionary.md`）+ 失败阻断（`acceptance.md`）

5) **告警疲劳**：误报率高导致运营失效  
   - 缓解：分阶段 rollout（本文件）+ 告警规则变更可审计（`audit_log.md`）

## 非目标
- 不规定具体存储/消息队列/监控方案。
- 不包含任何代码路径、伪代码或接口实现。
