# 身份与数据隔离 Design

## 设计意图
本设计文档用于固定「身份与数据隔离」在规格层面的设计立场：契约、数据完整性、门禁与审计。禁止写实现细节。

## 依赖关系
- 上游依赖：无

## 必备标识符（最小集）
- `user_id`, `org_id`, `version_id`

## 关键决策（非实现）
- 所有用户可见结论必须可追溯到 `version_id` 与证据链（如适用）。
- 门禁失败必须阻断晋级，并产出可行动的整改项清单。
- 可观测与审计字段是契约的一部分，必须被一致执行。

## 数据完整性语义（规格层）

### 引用可解析性（MUST）
- 任何与身份相关的引用字段（如 `user_id`/`org_id`、资源引用 `resource_type/resource_id`）在进入下游阶段前 MUST 满足可解析性与隔离约束：
  - 在不泄露额外信息的前提下，系统 MUST 能判定其是否属于当前 `user_id/org_id` 作用域。
- 引用不可解析或跨边界 MUST 失败并阻断；同时 MUST 产出可审计的失败原因（见契约 `rejection_reasons`）。

### 幂等 / 去重（MUST）
- 系统 MUST 定义确定性的去重键，以避免重复写入造成的审计噪音与证据漂移；去重键仅允许由契约字段构成。
- 约定的最小去重键（规格级语义）：
  - 访问控制决策记录：`decision_id`
  - 隔离违规审计事件：`event_id`
  - 删除/保留审计记录：`audit_id`
- 对相同去重键的重复提交：
  - 若提交内容等价（在本 spec 定义的等价范围内）SHALL 视为幂等成功。
  - 若提交内容不等价 MUST 视为冲突并拒绝（例如 `VALIDATION_FAILED`）。

### 冲突处理（MUST）
- 冲突的判定与拒绝原因 MUST 可复现、确定性（相同输入得到相同拒绝代码）。
- 冲突 MUST 记录审计事件，且审计记录必须遵循最小化/脱敏原则。

## 运行时确定性与偏差口径（规格层）

### 确定性边界（SHALL）
- 在相同输入（含 `user_id`/`org_id`/`version_id` 等契约字段）与相同授权语义（同一版本的策略/规则语义）重复执行时：
  - 决策输出（ALLOW/DENY/BLOCK、拒绝原因代码）SHALL 等价。
  - 关键审计产物（决策记录、违规事件、删除/保留审计）在本 spec 定义的等价范围内 SHALL 等价。

### 等价范围（最小）
- 允许的非确定性字段（若存在）MUST 被显式标注并可审计，例如：
  - `created_at/occurred_at` 时间戳
  - 系统生成的 `decision_id/audit_id/event_id`（若未由调用方提供）
- 除上述显式允许项外，输出差异 MUST 视为偏差。

### 偏差检测与解释（MUST）
- 系统 MUST 具备偏差检测能力：当相同输入在相同版本语义下产生非等价输出时，必须形成可审计的偏差事件。
- 偏差事件 MUST 至少包含：`user_id`、`org_id`、`version_id`、偏差类型、拒绝原因（若适用）、关联 `request_id/trace_id`（若适用）。

## 失败处理策略与信号产物（规格层）

### 失败分类（最小）
- **拒绝（DENY）**：缺失/非法身份字段、跨租户访问意图、未授权等（通常不可重试）。
- **阻断（BLOCK）**：策略/规则不可用导致无法保证隔离与审计（通常需要人工整改或回滚）。
- **内部错误（INTERNAL_ERROR）**：非预期异常（可能可重试）。

### 策略（MUST/SHALL）
- 对于拒绝与越权，系统 MUST 返回确定性的拒绝原因代码（见契约 `rejection_reasons`）并写入审计记录。
- 对于内部错误，系统 SHOULD 标记 `retryable=true` 并允许上游按策略重试；重复失败 MUST 触发阻断信号。
- 对于阻断场景，系统 MUST 形成可行动的整改项线索（最小：失败类别、影响面、关联标识符）。

### 信号产物（最小）
- metrics：拒绝/越权计数、拒绝原因分布、阻断事件计数（见 `observability.md`）。
- logs/traces：可按 `user_id`/`org_id`/`version_id`/`request_id`（若适用）定位。
- audit：对关键拒绝/越权/阻断必须生成审计记录（见 `audit_log.md`）。

## 发布策略（Rollout）与回滚触发（规格层）

### 分阶段 rollout（最小）
- **Shadow**：在不影响对外行为的前提下并行产出鉴权决策与审计记录，用于验证隔离一致性与拒绝原因分布。
- **Canary**：仅对一小部分请求路径或租户范围生效，重点监控隔离违规与阻断事件。
- **Gradual**：逐步扩大生效范围，直至全量；扩容步骤 MUST 可审计（记录 rollout 阶段与范围）。

### 回滚触发条件（MUST）
- `ls_identity_isolation_violations_total` 异常抬升 MUST 触发回滚或阻断。
- 审计记录不可用/不可导出 MUST 视为 Gate-0 阻断条件。
- 鉴权决策延迟或失败率显著恶化（超过 SLO）MUST 触发回滚或降级。

## Top 风险与缓解（写入门禁/证据/回退）

1) **跨租户数据泄露**：错误的 `user_id/org_id` 绑定导致越权读取/写入  
   - 缓解：隔离边界与拒绝策略（`security.md`）+ 违规审计与导出（`audit_log.md`/`compliance.md`）+ Gate-0 阻断策略（`acceptance.md`）

2) **鉴权决策不一致（漂移）**：同输入在同版本语义下得到不同决策  
   - 缓解：确定性边界与偏差口径（本文件）+ 偏差审计事件（本文件）+ 回归基线（Gate-0）

3) **高基数可观测导致成本失控**：将 `user_id/org_id` 作为 metric 标签  
   - 缓解：标签约束（`observability.md`）+ 成本阈值与告警（`cost.md`）

4) **审计缺失导致不可追责**：关键拒绝/越权/阻断未形成审计链路  
   - 缓解：审计字段契约（`audit_log.md`）+ 合规证据项与期限（`compliance.md`）+ Gate-0 失败阻断（`acceptance.md`）

5) **删除/保留策略冲突**：删除请求与合规保留要求矛盾导致不可执行或不可审计  
   - 缓解：合规口径（`compliance.md`）+ 删除/保留审计记录字段约束（`data_dictionary.md`）

## 非目标
- 不规定具体存储/消息队列/监控方案。
- 不包含任何代码路径、伪代码或接口实现。
