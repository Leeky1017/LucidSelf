# 版本化与偏差检测 Design

## 设计意图
本设计文档用于固定「版本化与偏差检测」在规格层面的设计立场：契约、数据完整性、门禁与审计。禁止写实现细节。

## 依赖关系
- 上游依赖：`engine-id-governance`

## 必备标识符（最小集）
- `version_id`, `engine_id`

## 关键决策（非实现）
- 所有用户可见结论必须可追溯到 `version_id` 与证据链（如适用）。
- 门禁失败必须阻断晋级，并产出可行动的整改项清单。
- 可观测与审计字段是契约的一部分，必须被一致执行。

## 数据完整性语义（规格层）

### 引用可解析性（MUST）
- `DeviationReport.version_id` 与 `DeviationReport.baseline_version_id` MUST 可解析到版本清单；不可解析 MUST 失败并阻断。
- `CompatibilityStatement.from_version_id/to_version_id` MUST 可解析到版本清单；不可解析 MUST 失败并阻断。
- `BlockRecord.version_id` MUST 可解析到版本清单；不可解析 MUST 失败并阻断。

### 幂等 / 去重（MUST）
- 系统 MUST 定义确定性的去重键，以避免重复写入造成的版本漂移；去重键仅允许由契约字段构成。
- 约定的最小去重键（规格级语义）：
  - 版本清单：`version_id`
  - 兼容性声明：`from_version_id` + `to_version_id`
  - 偏差报告：`report_id`
  - 阻断记录：`block_id`
- 对相同去重键的重复提交：
  - 若提交内容等价 SHALL 视为幂等成功。
  - 若提交内容不等价 MUST 视为冲突并拒绝（例如 `VALIDATION_FAILED`）。

### 冲突处理（MUST）
- 冲突的判定与拒绝原因 MUST 可复现、确定性（相同输入得到相同拒绝代码）。
- 冲突 MUST 记录审计事件。

## 运行时确定性与偏差口径（规格层）

### 确定性边界（SHALL）
- 在相同输入与相同版本语义下重复执行时：
  - 版本解析结果（解析到的 `version_id`/兼容性判定）SHALL 等价。
  - 偏差检测结论（偏差类型/是否阻断）SHALL 等价。

### 等价范围（最小）
- 允许的非确定性字段（若存在）MUST 被显式标注并可审计（例如时间戳、系统生成的报告标识）。
- 除显式允许项外，输出差异 MUST 视为偏差并可审计。

### 偏差检测与解释（MUST）
- 系统 MUST 能检测并报告偏差（至少覆盖：输出漂移、兼容性不满足、缺失基线）。
- 偏差报告 MUST 至少包含：`version_id`、`baseline_version_id`、偏差类型与可行动摘要。

## 失败处理策略与信号产物（规格层）

### 失败分类（最小）
- **拒绝（DENY）**：缺失/非法版本标识、基线不可解析、兼容性不满足等（通常不可重试）。
- **阻断（BLOCK）**：门禁失败或无法保证可复现/可审计（需要人工整改或回滚）。
- **内部错误（INTERNAL_ERROR）**：非预期异常（可能可重试）。

### 策略（MUST/SHALL）
- 对于可判定问题，系统 MUST 返回确定性的拒绝原因代码（见契约 `rejection_reasons`）并形成审计记录或阻断记录。
- 对于阻断场景，系统 MUST 产出阻断记录（`BlockRecord`）与可行动整改线索。
- 对于内部错误，系统 SHOULD 标记 `retryable=true` 并允许上游按策略重试；重复失败 MUST 触发阻断。

## 发布策略（Rollout）与回滚触发（规格层）

### 分阶段 rollout（最小）
- **Shadow**：并行运行版本解析与偏差检测，不影响对外发布，用于验证基线与偏差阈值。
- **Canary**：对小范围版本/引擎启用阻断策略，观察误报与性能开销。
- **Gradual**：逐步扩大阻断策略生效范围直至全量；扩容步骤 MUST 可审计。

### 回滚触发条件（MUST）
- 偏差误报率显著上升导致正常发布被阻断 MUST 触发回滚或阈值调整（需可审计）。
- 偏差检测不可用或基线不可解析导致无法判定 MUST 触发阻断并停止晋级。

## Top 风险与缓解（写入门禁/证据/回退）

1) **版本不可追溯**：输出无法关联到 `version_id`/`engine_id`  
   - 缓解：契约字段与数据字典约束（本 spec）+ Gate-0 阻断策略（`acceptance.md`）

2) **基线不稳定**：基线版本漂移导致偏差判定不可复现  
   - 缓解：引用可解析性与幂等语义（本文件/`data_dictionary.md`）+ 偏差报告固定 baseline_version_id

3) **偏差检测误报/漏报**：阈值不合理导致发布被错误阻断或放行  
   - 缓解：分阶段 rollout（本文件）+ 偏差报告可审计摘要（契约）+ 阻断记录可追责（契约）

4) **高成本回归**：偏差检测计算量激增导致成本失控  
   - 缓解：成本阈值与告警（`cost.md`）+ 观测指标（`observability.md`）

5) **阻断不可追责**：门禁阻断缺少证据链  
   - 缓解：BlockRecord 字段约束（契约/数据字典）+ 审计导出（`audit_log.md`/`compliance.md`）

## 非目标
- 不规定具体存储/消息队列/监控方案。
- 不包含任何代码路径、伪代码或接口实现。
