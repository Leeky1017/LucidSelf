# 生产默认值（禁止Mock） Design

## 设计意图
本设计文档用于固定「生产默认值（禁止Mock）」在规格层面的设计立场：契约、数据完整性、门禁与审计。禁止写实现细节。

## 依赖关系
- 上游依赖：`identity-and-data-isolation`, `security-privacy-compliance`

## 必备标识符（最小集）
- `version_id`

## 关键决策（非实现）
- 所有用户可见结论必须可追溯到 `version_id` 与证据链（如适用）。
- 门禁失败必须阻断晋级，并产出可行动的整改项清单。
- 可观测与审计字段是契约的一部分，必须被一致执行。

## 数据完整性语义（规格层）

### 引用可解析性（MUST）
- `reason_code` MUST 可解析到契约枚举 `rejection_reasons[*].code`；不可解析 MUST 失败并阻断。
- `environment` MUST 可解析到受控集合（prod/staging/dev 等）；不可解析 MUST 失败并阻断。

### 幂等 / 去重（MUST）
- 系统 MUST 定义确定性的去重键，以避免重复规则/记录造成的治理漂移；去重键仅允许由契约字段构成。
- 约定的最小去重键（规格级语义）：
  - 配置校验规则：`rule_id`
  - 环境隔离约束：`constraint_id`
  - 启动失败记录：`failure_id`
  - 违规审计：`audit_id`
- 对相同去重键的重复提交：
  - 若提交内容等价 SHALL 视为幂等成功。
  - 若提交内容不等价 MUST 视为冲突并拒绝（例如 `VALIDATION_FAILED`）。

### 冲突处理（MUST）
- 冲突的判定与拒绝原因 MUST 可复现、确定性（相同输入得到相同拒绝代码）。
- 冲突 MUST 记录审计事件。

## 运行时确定性与偏差口径（规格层）

### 确定性边界（SHALL）
- 在相同配置输入与相同 `version_id` 下重复校验时：
  - 校验结论（ALLOW/DENY/BLOCK、拒绝原因代码）SHALL 等价。
  - 关键违规审计（若触发）在本 spec 定义的等价范围内 SHALL 等价。

### 等价范围（最小）
- 允许的非确定性字段（若存在）MUST 被显式标注并可审计（例如时间戳、系统生成的记录标识）。
- 除显式允许项外，输出差异 MUST 视为偏差并可审计。

### 偏差检测与解释（MUST）
- 系统 MUST 能检测生产默认值规则漂移（例如同一配置在同一版本语义下出现不同结论）。
- 偏差事件 MUST 至少包含：`version_id`、环境、偏差类型、拒绝原因（若适用）与最小可行动摘要。

## 失败处理策略与信号产物（规格层）

### 失败分类（最小）
- **拒绝（DENY）**：配置缺失/非法、环境不匹配等（通常不可重试）。
- **阻断（BLOCK）**：检测到 mock 默认值或静默降级等违反生产红线（必须阻断晋级/启动）。
- **内部错误（INTERNAL_ERROR）**：非预期异常（可能可重试）。

### 策略（MUST/SHALL）
- 对于违反生产红线（MOCK_DEFAULT/SILENT_DEGRADATION），系统 MUST 阻断并生成违规审计记录。
- 对于可判定校验失败，系统 MUST 返回确定性的拒绝原因代码并生成失败原因记录（用于可行动整改）。
- 对于内部错误，系统 SHOULD 标记 `retryable=true` 并允许上游按策略重试；重复失败 MUST 触发阻断。

## 发布策略（Rollout）与回滚触发（规格层）

### 分阶段 rollout（最小）
- **Shadow**：并行执行生产默认值校验但不阻断，用于验证规则覆盖率与误报率（仅限非生产环境或受控场景）。
- **Canary**：对小范围服务/环境启用阻断策略，监控启动失败与违规计数。
- **Gradual**：逐步扩大阻断策略生效范围直至全量；扩容步骤 MUST 可审计。

### 回滚触发条件（MUST）
- 误报导致大面积启动失败或发布阻断 MUST 触发回滚或规则调整（需可审计）。
- 检测到真实违规（mock/静默降级）MUST 阻断并触发回滚/修复流程。

## Top 风险与缓解（写入门禁/证据/回退）

1) **生产默认值违规未被阻断**：mock/静默降级进入生产  
   - 缓解：红线阻断策略（本文件）+ 违规指标与审计（`observability.md`/`audit_log.md`）+ Gate-0 阻断（`acceptance.md`）

2) **规则误报导致不可用**：过严规则导致启动失败  
   - 缓解：分阶段 rollout（本文件）+ 启动失败原因记录（契约/`data_dictionary.md`）+ 回滚触发条件（本文件）

3) **环境隔离失效**：生产/非生产配置串扰  
   - 缓解：环境隔离约束（契约/数据字典）+ 访问控制（`security.md`）

4) **审计缺失导致不可追责**：违规未形成审计链路  
   - 缓解：审计字段契约（`audit_log.md`）+ 合规留存（`compliance.md`）

5) **配置漂移不可复现**：同版本/同配置得到不同校验结论  
   - 缓解：确定性边界与偏差口径（本文件）+ 偏差事件可审计（本文件/`observability.md`）

## 非目标
- 不规定具体存储/消息队列/监控方案。
- 不包含任何代码路径、伪代码或接口实现。
