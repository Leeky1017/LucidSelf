'use client';

/**
 * 省市级联选择组件
 * 
 * 支持：
 * - 省份 → 城市级联选择
 * - 搜索过滤
 * - 常用城市快捷选择
 */

import { useState, useEffect, useRef, useCallback } from 'react';
import { ChevronDown, Search, MapPin, X, Check } from 'lucide-react';
import { useTranslation } from '@/lib/i18n';
import { api, type CommonCityResponse } from '@/lib/api';

// 中国省份列表
const PROVINCES = [
  '北京', '天津', '上海', '重庆',
  '河北', '山西', '辽宁', '吉林', '黑龙江',
  '江苏', '浙江', '安徽', '福建', '江西', '山东',
  '河南', '湖北', '湖南', '广东', '海南',
  '四川', '贵州', '云南', '陕西', '甘肃', '青海',
  '台湾', '内蒙古', '广西', '西藏', '宁夏', '新疆',
  '香港', '澳门',
];

interface SelectedCity {
  displayName: string;
  province: string;
  city: string;
  lat: number;
  lng: number;
  timezone: string;
}

interface CityPickerProps {
  value?: SelectedCity | null;
  onChange: (city: SelectedCity | null) => void;
  placeholder?: string;
}

export function CityPicker({ value, onChange, placeholder }: CityPickerProps) {
  const { t } = useTranslation();
  const [isOpen, setIsOpen] = useState(false);
  const [mode, setMode] = useState<'province' | 'city' | 'search'>('province');
  const [selectedProvince, setSelectedProvince] = useState<string | null>(null);
  const [searchQuery, setSearchQuery] = useState('');
  const [cities, setCities] = useState<CommonCityResponse[]>([]);
  const [filteredCities, setFilteredCities] = useState<CommonCityResponse[]>([]);
  const [commonCities, setCommonCities] = useState<CommonCityResponse[]>([]);
  const containerRef = useRef<HTMLDivElement>(null);

  // 加载常用城市
  useEffect(() => {
    api.geocoding.getChinaCommonCities()
      .then(setCommonCities)
      .catch(() => {
        // 使用备用数据
        setCommonCities([
          { name: '北京', province: '北京', display_name: '北京市', lat: 39.9042, lng: 116.4074, timezone: 'Asia/Shanghai' },
          { name: '上海', province: '上海', display_name: '上海市', lat: 31.2304, lng: 121.4737, timezone: 'Asia/Shanghai' },
          { name: '广州', province: '广东', display_name: '广东省广州市', lat: 23.1291, lng: 113.2644, timezone: 'Asia/Shanghai' },
          { name: '深圳', province: '广东', display_name: '广东省深圳市', lat: 22.5431, lng: 114.0579, timezone: 'Asia/Shanghai' },
          { name: '杭州', province: '浙江', display_name: '浙江省杭州市', lat: 30.2741, lng: 120.1551, timezone: 'Asia/Shanghai' },
          { name: '成都', province: '四川', display_name: '四川省成都市', lat: 30.5728, lng: 104.0668, timezone: 'Asia/Shanghai' },
        ]);
      });
  }, []);

  // 点击外部关闭
  useEffect(() => {
    function handleClickOutside(event: MouseEvent) {
      if (containerRef.current && !containerRef.current.contains(event.target as Node)) {
        setIsOpen(false);
      }
    }
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, []);

  // 过滤城市（搜索模式）
  useEffect(() => {
    if (!searchQuery.trim()) {
      setFilteredCities([]);
      return;
    }
    const filtered = commonCities.filter(
      c => c.name.includes(searchQuery) || 
           c.province.includes(searchQuery) ||
           c.display_name.includes(searchQuery)
    );
    setFilteredCities(filtered.slice(0, 10));
  }, [searchQuery, commonCities]);

  // 选择省份后加载城市
  useEffect(() => {
    if (!selectedProvince) {
      setCities([]);
      return;
    }
    const provinceCities = commonCities.filter(c => c.province === selectedProvince);
    setCities(provinceCities);
  }, [selectedProvince, commonCities]);

  const handleSelectProvince = (province: string) => {
    setSelectedProvince(province);
    setMode('city');
  };

  const handleSelectCity = useCallback((city: CommonCityResponse) => {
    onChange({
      displayName: city.display_name,
      province: city.province,
      city: city.name,
      lat: city.lat,
      lng: city.lng,
      timezone: city.timezone,
    });
    setIsOpen(false);
    setMode('province');
    setSelectedProvince(null);
    setSearchQuery('');
  }, [onChange]);

  const handleClear = () => {
    onChange(null);
    setSearchQuery('');
  };

  const handleBack = () => {
    if (mode === 'city') {
      setMode('province');
      setSelectedProvince(null);
    } else if (mode === 'search') {
      setMode('province');
      setSearchQuery('');
    }
  };

  return (
    <div className="city-picker" ref={containerRef}>
      {/* 输入框 */}
      <div 
        className={`picker-input ${isOpen ? 'active' : ''}`}
        onClick={() => setIsOpen(true)}
      >
        <MapPin size={16} className="input-icon" />
        {value ? (
          <>
            <span className="selected-value">{value.displayName}</span>
            <button 
              type="button" 
              className="clear-btn"
              onClick={(e) => { e.stopPropagation(); handleClear(); }}
            >
              <X size={14} />
            </button>
          </>
        ) : (
          <span className="placeholder">{placeholder || t.profile.searchCity}</span>
        )}
        <ChevronDown size={16} className="chevron-icon" />
      </div>

      {/* 下拉面板 */}
      {isOpen && (
        <div className="picker-dropdown">
          {/* 搜索框 */}
          <div className="search-box">
            <Search size={14} />
            <input
              type="text"
              placeholder={t.profile.searchCity}
              value={searchQuery}
              onChange={(e) => {
                setSearchQuery(e.target.value);
                setMode(e.target.value ? 'search' : 'province');
              }}
              autoFocus
            />
          </div>

          {/* 面包屑导航 */}
          {(mode === 'city' || mode === 'search') && (
            <div className="breadcrumb">
              <button type="button" onClick={handleBack}>
                ← {mode === 'city' ? t.profile.selectProvince : t.common.back}
              </button>
              {mode === 'city' && selectedProvince && (
                <span className="current">{selectedProvince}</span>
              )}
            </div>
          )}

          {/* 内容区域 */}
          <div className="picker-content">
            {mode === 'search' && searchQuery && (
              <>
                {filteredCities.length > 0 ? (
                  filteredCities.map(city => (
                    <button
                      key={`${city.province}-${city.name}`}
                      type="button"
                      className="city-item"
                      onClick={() => handleSelectCity(city)}
                    >
                      <MapPin size={14} />
                      <span>{city.display_name}</span>
                    </button>
                  ))
                ) : (
                  <div className="no-results">{t.common.noData}</div>
                )}
              </>
            )}

            {mode === 'province' && !searchQuery && (
              <>
                {/* 常用城市 */}
                <div className="section-header">{t.profile.commonCities}</div>
                <div className="common-cities">
                  {commonCities.slice(0, 8).map(city => (
                    <button
                      key={city.name}
                      type="button"
                      className="common-city-btn"
                      onClick={() => handleSelectCity(city)}
                    >
                      {city.name}
                    </button>
                  ))}
                </div>

                {/* 省份列表 */}
                <div className="section-header">{t.profile.selectProvince}</div>
                <div className="province-grid">
                  {PROVINCES.map(province => (
                    <button
                      key={province}
                      type="button"
                      className="province-btn"
                      onClick={() => handleSelectProvince(province)}
                    >
                      {province}
                    </button>
                  ))}
                </div>
              </>
            )}

            {mode === 'city' && selectedProvince && (
              <>
                {cities.length > 0 ? (
                  cities.map(city => (
                    <button
                      key={city.name}
                      type="button"
                      className="city-item"
                      onClick={() => handleSelectCity(city)}
                    >
                      <MapPin size={14} />
                      <span>{city.name}</span>
                      {value?.city === city.name && <Check size={14} className="check" />}
                    </button>
                  ))
                ) : (
                  <div className="no-results">
                    {t.profile.searchCity}
                  </div>
                )}
              </>
            )}
          </div>
        </div>
      )}

      <style jsx>{`
        .city-picker {
          position: relative;
          width: 100%;
        }

        .picker-input {
          display: flex;
          align-items: center;
          gap: var(--space-sm);
          padding: var(--space-sm) var(--space-md);
          background: var(--bg-middle);
          border: 1px solid var(--card-border);
          border-radius: var(--radius-md);
          cursor: pointer;
          transition: all 0.2s;
        }

        .picker-input:hover,
        .picker-input.active {
          border-color: var(--accent-gold);
        }

        .input-icon {
          color: var(--text-tertiary);
          flex-shrink: 0;
        }

        .selected-value {
          flex: 1;
          font-size: 0.95rem;
          color: var(--text-primary);
          text-align: left;
        }

        .placeholder {
          flex: 1;
          font-size: 0.95rem;
          color: var(--text-tertiary);
          text-align: left;
        }

        .clear-btn {
          display: flex;
          align-items: center;
          justify-content: center;
          padding: 2px;
          background: none;
          border: none;
          color: var(--text-tertiary);
          cursor: pointer;
        }

        .clear-btn:hover {
          color: var(--text-primary);
        }

        .chevron-icon {
          color: var(--text-tertiary);
          flex-shrink: 0;
        }

        .picker-dropdown {
          position: absolute;
          top: 100%;
          left: 0;
          right: 0;
          margin-top: 4px;
          background: var(--card-bg);
          border: 1px solid var(--card-border);
          border-radius: var(--radius-lg);
          box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
          z-index: 100;
          max-height: 400px;
          overflow: hidden;
          display: flex;
          flex-direction: column;
        }

        .search-box {
          display: flex;
          align-items: center;
          gap: var(--space-sm);
          padding: var(--space-sm) var(--space-md);
          border-bottom: 1px solid var(--card-border);
          color: var(--text-tertiary);
        }

        .search-box input {
          flex: 1;
          border: none;
          background: none;
          font-size: 0.9rem;
          color: var(--text-primary);
          outline: none;
        }

        .search-box input::placeholder {
          color: var(--text-tertiary);
        }

        .breadcrumb {
          display: flex;
          align-items: center;
          gap: var(--space-sm);
          padding: var(--space-xs) var(--space-md);
          background: var(--bg-middle);
          border-bottom: 1px solid var(--card-border);
        }

        .breadcrumb button {
          background: none;
          border: none;
          font-size: 0.8rem;
          color: var(--accent-gold);
          cursor: pointer;
        }

        .breadcrumb .current {
          font-size: 0.8rem;
          color: var(--text-secondary);
        }

        .picker-content {
          flex: 1;
          overflow-y: auto;
          padding: var(--space-sm);
        }

        .section-header {
          font-size: 0.75rem;
          color: var(--text-tertiary);
          text-transform: uppercase;
          letter-spacing: 0.05em;
          padding: var(--space-xs) var(--space-sm);
          margin-top: var(--space-sm);
        }

        .section-header:first-child {
          margin-top: 0;
        }

        .common-cities {
          display: flex;
          flex-wrap: wrap;
          gap: var(--space-xs);
          padding: var(--space-xs) var(--space-sm);
        }

        .common-city-btn {
          padding: var(--space-xs) var(--space-sm);
          background: var(--bg-middle);
          border: 1px solid var(--card-border);
          border-radius: var(--radius-sm);
          font-size: 0.85rem;
          color: var(--text-primary);
          cursor: pointer;
          transition: all 0.15s;
        }

        .common-city-btn:hover {
          background: var(--accent-gold);
          border-color: var(--accent-gold);
          color: #fff;
        }

        .province-grid {
          display: grid;
          grid-template-columns: repeat(4, 1fr);
          gap: 2px;
          padding: var(--space-xs);
        }

        .province-btn {
          padding: var(--space-sm);
          background: none;
          border: none;
          font-size: 0.85rem;
          color: var(--text-secondary);
          cursor: pointer;
          border-radius: var(--radius-sm);
          transition: all 0.15s;
        }

        .province-btn:hover {
          background: var(--bg-middle);
          color: var(--text-primary);
        }

        .city-item {
          display: flex;
          align-items: center;
          gap: var(--space-sm);
          width: 100%;
          padding: var(--space-sm) var(--space-md);
          background: none;
          border: none;
          font-size: 0.9rem;
          color: var(--text-primary);
          cursor: pointer;
          text-align: left;
          border-radius: var(--radius-sm);
          transition: background 0.15s;
        }

        .city-item:hover {
          background: var(--bg-middle);
        }

        .city-item .check {
          margin-left: auto;
          color: var(--accent-gold);
        }

        .no-results {
          text-align: center;
          padding: var(--space-xl);
          color: var(--text-tertiary);
          font-size: 0.9rem;
        }
      `}</style>
    </div>
  );
}

export default CityPicker;
