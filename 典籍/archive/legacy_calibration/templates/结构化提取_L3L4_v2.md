# 结构化提取_L3L4_v2

> 版本：v2.1（2025-11-27）  
> 角色与阶段：**面向后期系统级任务（L3/L4）**，用于规则内容层与叙事层的结构化设计。当前阶段的精校 agent **不使用本模板**。  
> 关联模板：  
> - L1/L2 精校与因子层八列表 → `典籍/精校模板_L1L2.md`  
> - L2.5 桥接层（因子关系/推理溯源/跨体系映射） → `典籍/精校模板_L2.5_桥接层.md`  
> - L3/L4 总体流程说明 → `典籍/典籍结构化作业手册.md`  
> - v2 之前的结构化提取草稿一律视为废弃，仅保留在版本历史中，不再作为现行规范依据。

---

## 0. 使用角色与边界

- **面向对象**：
  - **系统级 L3 agent**：从各典籍中的 `L3_CANDIDATE` 注释块与 L1/L2/因子层出发，整理稳定的规则说明稿与叙事素材；
  - **规则工程师**：参考本模板，将 L3 内容层映射为 Python 规则，并依据工程内 `RuleRegistry` / `RuleResult` 规范为 Narrative 生成器设计输入结构；
  - **产品 / 叙事设计**：在 L4 部分补充风格与 evidence 选取偏好。

- **当前阶段精校 agent 的边界**：
  - 只需在各典籍正文中：
    - 按 `精校模板_L1L2_v2` 完成 L1/L2 + 因子层；
    - 如发现清晰规则结构，在原文附近通过
      `<!-- L3_CANDIDATE_BEGIN ... --> ... <!-- L3_CANDIDATE_END -->`
      标记候选规则；
  - **不要求**也**不允许**在本文件中为每条原文手写 L3/L4 内容；
  - 本文件由后续系统级任务在合适阶段集中维护。

- **与历史资产的关系**：
  - v2 之前的结构化提取草稿一律视为历史资产，仅保留在版本记录中，不再作为现行规范依据；
  - 后续系统级任务只需基于当前已完成的 L1/L2 + 因子层输出整理 L3/L4 内容；
  - 不要求为兼容旧版本而重写任何已完成的 L1/L2 正文。

---

## 1. 条目外层结构与定位

### 1.1 条目锚点与来源引用

每一条 L3/L4 记录，必须能明确追溯到对应的 L1/L2 条目与因子层。推荐外层结构：

- `### [书名]·[章节]·[条次/小节标题]`
  - 示例：`### 滴天髓·通神论·甲木条`。
- 基本元信息：
  - `source_book`: 书名（如 "滴天髓"、"梦林玄解"）。
  - `source_chapter`: 章节名 / 卷名。
  - `source_entry`: 条次或原文首句摘要（与 L1 模板 `[序号]. [原文首句]` 对应）。
  - `l1_anchor`: 指向原典籍文件中的锚点（如 Markdown heading / 自定义 id）。
  - `l2_refs`: 关联的 L2 小节标题或语义标签（可在入库后补写 `semantic_id`）。

> 规则与叙事层**不重复抄写 L1/L2 正文**，只做引用与链接；如需引用原文，使用短句或行号说明。

### 1.2 L3 与 L4 的分层结构

在每个条目下，按顺序包含：

1. **L3 内容层：规则说明稿**  
   - 规则列表（表格或 YAML 风格）；
   - 命理内核（要点）；
   - 应用推演（操作顺序）；
   - 反例与边界；
   - 小例（示意）；
   - 规则原型挂点（选填）。

2. **L4 叙事层：Narrative 草案**  
   - 叙事配置（风格、受众等）；
   - 证据与标签选择策略；
   - Prompt 片段与表达偏好；
   - 风险提示与边界话术建议。

---

## 2. L3 内容层：规则说明稿

### 2.1 规则列表结构（每条规则一行）

推荐使用表格形式记录规则清单：

| 规则ID草案 | 规则标签（人话） | 关联 L2 / semantic 核心 | 条件（人话） | 结果维度 | 结果方向 | 结果描述（人话） | 引用的 L1/L2 片段与因子 | 适用范围/备注 |
|------------|------------------|-------------------------|--------------|----------|----------|------------------|--------------------------|----------------|
| dts_jiamu_spring_001 | 甲木春生木旺 | 甲木·春季·旺相 | [在何种命局/梦境结构下] | 事业/性格/… | 吉/凶/中性/混合 | 倾向性结果与典型表现 | 引用哪几条 L1/L2 与因子标签 | 使用边界与注意事项 |
| …          | …                | …                       | …            | …        | …        | …                | …                        | …              |

**字段说明：**

- **规则ID草案**：
  - 采用 `典籍简称_主题_序号` 风格，如：`dts_jiamu_spring_001`；
  - 在内容层只视为草案 ID，最终规则 ID 由工程侧在 Python 规则中确定；
  - 若已有正式 Python 规则 ID，可在备注中标注映射关系。

- **规则标签（人话）**：
  - 一句话概括本规则要表达的核心含义，如「甲木春生，生命力旺盛」；
  - 供人类快速浏览与聚类使用。

- **关联 L2 / semantic 核心**：
  - 指明本规则附着的 L2 语义单元，可填写：
    - L2 小节标题；
    - 或人话标签（如「甲木春生·根气充足」）；
  - 在 semantic 入库后，可补上对应 `semantic_id`（如 `dts_jiamu_core_001`）。

- **条件（人话）**：
  - 写成完整 if 条件句，描述「在什么前提 / 命局 / 梦境结构下」；
  - 必须能在 L2 与因子层中找到依据，不在此处发明新前提。

- **结果维度**：
  - 规则结论落在哪个分析维度，如：
    - 格局结构 / 风险水平 / 事业 / 财运 / 关系 / 健康 / 心理状态 / 梦者自我感受等。

- **结果方向**：
  - 典型取值：`吉` / `凶` / `中性` / `混合` 等；
  - 可结合后续评分体系（如弱吉/强吉）在工程层细化。

- **结果描述（人话）**：
  - 用自然语言完整描述「在该条件下典型会发生什么倾向或风险」；
  - 面向专业读者与系统设计者，而非直接终端用户话术。

- **引用的 L1/L2 片段与因子**：
  - 列出支撑本规则的：
    - L1 关键句或行号；
    - L2 要点（主题 / 自然属性 / 条件等）；
    - 因子层中相关的「因子标签（人话）」或 `existing` 因子 ID；
  - 用于追溯与交叉审计，便于系统校验「每条规则都有证据」。

- **适用范围/备注**：
  - 说明规则适用的局限条件，如：
    - 仅适用于某一类命局 / 梦型 / 场景；
    - 与其他规则的优先级或冲突关系；
  - 可简要记录与 Python 规则 ID、版本的对应关系。

> 本表是**内容层**的规则清单，使用自然语言与人话标签组织，不承担直接执行。真正可执行的判定逻辑在 Python 规则中实现，以工程内 `RuleRegistry` / `RuleResult` 相关代码与文档为准。

---

### 2.2 命理内核（要点）

在规则表之后，用 3–6 条要点总结本条目的「命理内核」：

- **命理内核（要点）**：
  - `[要点1：可直接用于造规则的核心逻辑]`
  - `[要点2：……]`
  - `[要点3：……]`

写作要点：

- 尽量复用规则表中的条件与结果，用更抽象但仍可落地的语言表达；
- 面向「跨书对齐」「冲突矩阵设计」「权重校准」等系统级任务；
- 不扩散到与本条无关的理论发挥。

---

### 2.3 应用推演（操作顺序）

用于描述**人类命理师 / 系统在实际使用时**如何按步骤应用本条规则：

1. `[第一步：先观察哪些因子 / 结构（引用因子层与 L2 条件）]`
2. `[第二步：如何组合这些因子形成判断（如先看身强身弱，再看财官配合）]`
3. `[第三步：如何随大运流年 / 环境变化调整判断]`
4. `[第四步：哪些场景下应该谨慎使用或暂缓下结论]`

> 本节既服务于后续 UI / Flow 设计，也服务于将规则拆解为多条 Python 函数时的结构化参考。

---

### 2.4 反例与边界

- **反例**：
  - `[典型误用 1：在何种情况下表面符合条件，其实结论不成立]`
  - `[典型误用 2：……]`

- **适用边界**：
  - `[边界 1：本条仅在……前提下成立，不适合用于……]`
  - `[边界 2：与某某规则冲突时，如何处理优先级]`

> 此处重点是「本规则什么时候不适用」，为后续冲突矩阵与不确定性建模提供素材。

---

### 2.5 小例（示意）

- `[示意例 1：用简化的命局 / 梦境结构说明本条规则如何触发]`
- `[示意例 2：可选，用于展示反面或边界情况]`

写作要求：

- 可以是匿名 / 抽象命例，不必是真实完整八字；
- 突出**结构与因子组合**，而非讲故事；
- 为后续测试用例与 Narrative 样例提供素材。

---

### 2.6 规则原型挂点（可选）

用于将内容层规则与工程层实现建立轻量级关联：

- `rule_prototype_id`: `[如 dts_jiamu_spring_001]`
- `python_rule_id`（可选）：`[如 dts_jiamu_spring_vitality]`
- `notes`: 简要说明该规则在代码库中的位置、版本与兼容性备注。

> v2 中不再要求维护 YAML / JSON 规则原型文件；`rule_prototype_id` 更偏向「概念 ID」，方便跨书对齐与溯源。真正的执行逻辑以 Python 规则为准。

---

## 3. L4 叙事层：Narrative 草案

L4 层用于为 Narrative 生成器（如 NarrativeGenerator）提供**结构化的表达配置**，而不是直接写给用户看的完整长文。

### 3.1 叙事配置结构

推荐以表格或 YAML 风格记录：

```yaml
narrative_profile:
  target_rules: ["dts_jiamu_spring_001", "dts_jiamu_spring_002"]  # 关联的规则ID草案
  tone: "温暖"  # 可选：冷静 / 温暖 / 直白 / 严肃 / 幽默 / …
  perspective: "second_person"  # 视角：第一人称 / 第二人称 / 第三人称
  intensity: "medium"  # 表达力度：轻描淡写 / 适中 / 强烈

  evidence_strategy:
    quote_l1: true            # 是否直接引用原文句子
    quote_l2_summary: true    # 是否引用 L2 要点
    surface_factors:          # 在文案中显式点名的因子
      - "甲木日主"
      - "出生于春季"

  prompt_blocks:
    opening_hint: |
      先用一两句话描述整体气质，再点出甲木在春季的生命力意象。
    risk_hint: |
      如果存在过旺或受制的情况，用温和的方式提示潜在压力与成长空间。
    closing_hint: |
      收尾时给出一条建设性建议，避免绝对化判断。

  safety_and_boundaries:
    avoid_claims:
      - "决定命运的唯一因素"
      - "不可逆转的厄运"
    required_disclaimers:
      - "本解读基于传统命理象义，仅供自我觉察与参考，不构成现实决策依据。"
```

说明：

- `target_rules`：本叙事配置主要服务于哪几条规则（可是一组共鸣主题）。
- `tone` / `perspective` / `intensity`：约束整体表达风格，与 LS 总体设计（Less UI, More Soul）保持一致。
- `evidence_strategy`：指导 Narrative 何时引用原文句子、L2 要点与因子标签。  
- `prompt_blocks`：为 LLM Prompt 提供可复用的文案片段与结构，而非最终输出文本。  
- `safety_and_boundaries`：避免夸大、宿命论等表达，并规定必须出现的免责声明。

---

### 3.2 L4 写作边界

- L4 不直接生成用户可见的完整文案，只提供「结构 + 提示语块」；
- 不在此层进行新的规则推理，一切结论必须来自已经定义的 L3 规则集合；
- 不与 UI 细节（颜色、布局等）耦合，只关注语义与话术；
- 后续可由产品 / 设计补充「模板化布局」（如卡片式、时间线式等）。

---

### 3.3 NarrativeSnippet 提取规范

叙事片段（NarrativeSnippet）是从 L1L2 精校产出中提炼的、可直接作为 LLM 参考素材的精炼短句。在 L3L4 阶段，需要将精校产出的叙事素材标注整理为结构化的 NarrativeSnippet 表。

#### 3.3.1 NarrativeSnippet 表结构

| snippet_id | trigger_condition | zh_snippet | source_ref | related_rules |
|------------|-------------------|------------|------------|---------------|
| ns_dts_001 | day_master=甲 AND season∈[春] | 甲木如参天大树，其性质刚健向上、直冲云霄。 | 《滴天髓·通神论》#甲木条 | dts_jiamu_spring_001 |
| ns_dts_002 | day_master=甲 AND lacks(火) | 若无火则生机郁结，若无金则枝叶蔓生而失其正形。 | 《滴天髓·通神论》#甲木条 | dts_jiamu_spring_001 |
| ns_dts_003 | condition=地润天和 | 地气滋润而不湿，天气调和而不燥，甲木便能扎根深厚、挺立千古。 | 《滴天髓·通神论》#甲木条 | dts_jiamu_spring_001 |

**字段说明**：
- **snippet_id**：唯一ID，格式 `ns_书籍简称_序号`，与 L1 中标注的 ID 一致
- **trigger_condition**：触发条件，使用因子层的 `existing` 因子 ID 表达（可为伪代码形式）
- **zh_snippet**：精炼中文短句，10-30 字，有画面感，可独立理解
- **source_ref**：溯源锚点，精确到章节或行号
- **related_rules**：关联的 L3 规则 ID（可选，用于规则命中时检索合适片段）

#### 3.3.2 提取来源与优先级

叙事片段的来源按优先级排序：

1. **L1 叙事素材标注**：精校 agent 已在 L1 中标注的 `narrative_snippets`，直接迁入
2. **L1 核心要点**：高度浓缩的要点句，可直接作为叙事素材
3. **L1 规范化释义**：从释义中提取有画面感的精炼句
4. **L2 主题/属性描述**：可提取为主题句或属性描述

#### 3.3.3 提取约束

- **必须有原文依据**：每个片段必须能追溯到 L1 原文或释义
- **禁止自由创作**：不可脱离原文发挥，不可编造
- **控制长度**：10-30 字为宜，过长需拆分，过短需补充完整
- **有画面感**：优先选取有比喻、有意象的句子
- **可独立理解**：不需要上下文即可理解基本含义

#### 3.3.4 与 Playbook 的关系

NarrativeSnippet 是 Playbook 生成的核心素材：

```
RuntimeRuleResult（规则命中）
       ↓
trigger_condition 匹配
       ↓
NarrativeSnippet 检索
       ↓
TOON + Snippets → LLM
       ↓
Playbook 自然语言输出（带 inline_sources 追溯）
```

> 详细的 Playbook 生成流程与 NarrativeSnippet 使用方式，见 `docs/ls_knowledge_to_output_pipeline.md` 第五章。

---

## 3.4 L2.5 桥接层到 L3 规则的转化

### 3.4.1 从 ConfigRelation 生成规则

L2.5 因子关系层经 Schema 校验后，可通过 Codegen 生成 Python 规则：

```python
# 由 Codegen 从 ConfigRelation 生成
# 来源: rel_dts_001 | wuxing_shengke | day_master_jia | element_fire | 生 | - | 增益

@register_rule(rule_id="rel_jia_fire_001", category="wuxing_shengke")
def evaluate_jia_fire_relation(
    factor_matrix: FactorMatrix,
    ctx: RuleExecutionContext
) -> RuntimeRuleResult:
    """甲木得火疏泄"""
    jia = factor_matrix.factors.get("day_master_jia")
    fire = factor_matrix.factors.get("element_fire")
    
    if jia and jia.value and fire and fire.value:
        return RuntimeRuleResult(
            rule_id="rel_jia_fire_001",
            matched=True,
            dimension="能量流通",
            level="吉",
            confidence=0.85,
            weight=1.2,
            tags=["木生火", "疏泄"],
            evidence_factors=["day_master_jia", "element_fire"],
            semantic_refs=["dts_v2_jia_001"],
            source_book="滴天髓",
            l1_anchor="甲木条#脱胎要火",
            execution_time_ms=1.0
        )
    return RuntimeRuleResult(rule_id="rel_jia_fire_001", matched=False, ...)
```

### 3.4.2 从 EvidenceChainEntry 生成规则

L2.5 推理溯源层经 Schema 校验后，可生成带完整证据链的 Python 规则：

```python
# 由 Codegen 从 EvidenceChainEntry 生成
# 来源: evi_dts_002 | "春不容金" | day_master_jia, season_spring, element_metal | 春木旺遇金克 | 损害 | 高 | ✅

@register_rule(rule_id="evi_spring_metal_001", category="seasonal_constraint")
def evaluate_spring_avoid_metal(
    factor_matrix: FactorMatrix,
    ctx: RuleExecutionContext
) -> RuntimeRuleResult:
    """春不容金"""
    jia = factor_matrix.factors.get("day_master_jia")
    season = factor_matrix.factors.get("season")
    metal = factor_matrix.factors.get("element_metal")
    
    if (jia and jia.value and 
        season and season.value == "spring" and
        metal and metal.value):
        return RuntimeRuleResult(
            rule_id="evi_spring_metal_001",
            matched=True,
            dimension="季节宜忌",
            level="凶",
            confidence=0.90,
            weight=1.5,
            tags=["春不容金", "季节忌神"],
            evidence_factors=["day_master_jia", "season", "element_metal"],
            semantic_refs=["dts_v2_jia_001"],
            source_book="滴天髓",
            l1_anchor="甲木条#春不容金",
            execution_time_ms=1.2
        )
    return RuntimeRuleResult(rule_id="evi_spring_metal_001", matched=False, ...)
```

### 3.4.3 L2.5 到 L3L4 的数据流

```
┌─────────────────────────────────────────────────────────────────────────┐
│  L2.5 桥接层（Markdown 表格）                                            │
│  ┌────────────────┐ ┌────────────────┐ ┌────────────────┐              │
│  │ 因子关系层      │ │ 推理溯源层      │ │ 跨体系映射      │              │
│  │ ConfigRelation │ │ EvidenceChain  │ │ CrossSystem    │              │
│  └────────────────┘ └────────────────┘ └────────────────┘              │
└──────────────────────────────┬──────────────────────────────────────────┘
                               ↓ 提取脚本 + Schema校验
┌─────────────────────────────────────────────────────────────────────────┐
│  JSON/JSONL 配置源码（离线中转，版本控制）                                  │
│  data/relations/*.jsonl  data/evidence/*.jsonl  data/mappings/*.jsonl   │
└──────────────────────────────┬──────────────────────────────────────────┘
                               ↓ Codegen 编译
┌─────────────────────────────────────────────────────────────────────────┐
│  L3 规则层（Python 代码）+ L4 叙事层                                       │
│  backend/rules/generated/*.py  backend/narrative/snippets/*.py          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 4. 不重刷旧书与迁移策略

为避免在 L3/L4 阶段触发对既有 L1/L2 成果的全盘重写，本模板下的系统级任务需要遵守：

1. **尊重既有 L1/L2 与因子层**：  
   - 只要现有内容大体符合 `精校模板_L1L2_v2` 精神，即视为合格输入；
   - L3/L4 工作在其之上做「规则总结与叙事设计」，而不是要求内容侧重新写一遍 L1/L2。

2. **从 L3_CANDIDATE 与历史规则出发**：  
   - 优先消化已有的 `L3_CANDIDATE` 注释块、v0 JSON/YAML 规则与结构化提取笔记；
   - 在迁移过程中，将这些信息整理为本模板中的规则表、命理内核、应用推演等；
   - 仅在明显缺失时，才新增规则说明稿，而不回溯要求大范围改写正文。

3. **分阶段治理，而非一次性大清洗**：  
   - 可以按书 / 按章节 / 按主题分批完成 L3/L4 整理；
   - 每一批次只要求在本模板内闭环，不要求同步改动所有典籍文件；
   - 如需对 L1/L2 进行小幅补充（例如增加锚点或补一句解释），应通过独立任务评估，不绑在 L3/L4 文档整理本身。

4. **明确职责分工**：  
   - 精校 agent：专注于 L1/L2 + 因子层，遵守 `精校模板_L1L2_v2` 与手册中的约束；
   - 系统级 L3/L4 任务：负责本文件的维护与扩展，以及与 Python 规则、Narrative 引擎的对接；
   - 工程团队：负责将 L3 内容层 + 因子层 + L4 叙事配置映射为可执行代码与运行时配置。

---

## 5. 总结：L1/L2 在前，L3/L4 在后

- 所有典籍结构化工作遵循「**先 L1/L2 + 因子层，后 L3 内容层，再 L4 叙事层**」的顺序；
- 本文件只定义 **未来 L3/L4 内容规范**，不改变任何一本书中已完成的 L1/L2 正文；
- 当前阶段的精校 agent 只需：
  - 按 `精校模板_L1L2_v2` 做好每条 L1/L2 与因子层；
  - 在需要时用 `L3_CANDIDATE` 注释标记规则候选；
- 后续，当系统级 L3/L4 任务启动时，再按本模板集中梳理规则与叙事层。
