# MVP 范围定义

> 第一版实现的边界与优先级

---

## MVP 目标

**核心验证假设**：
> 用户愿意为"可解释、可追溯、可选择的人生版本管理"付费。

**MVP 完成标准**：
1. 用户可以输入出生信息，获得命理因子计算
2. 系统生成 2-3 个人生版本选项
3. 用户可以选择版本，查看版本树
4. 用户可以记录行为，系统提供推演分析
5. 整个流程可闭环运行

---

## 功能矩阵

### ✅ MVP 必须实现

| 模块 | 功能 | 优先级 |
|------|------|--------|
| **命理计算** | 八字四柱、十神、格局 | P0 |
| **命理计算** | 大运、流年 | P0 |
| **命理计算** | 占星行星落座、主要相位 | P0 |
| **命理计算** | 占星太阳/月亮/上升 | P0 |
| **版本生成** | 基于因子生成 2-3 版本 | P0 |
| **版本生成** | 版本对比矩阵 | P0 |
| **版本树** | 创建和展示版本树 | P0 |
| **版本树** | 记录用户选择 | P0 |
| **记忆层** | Event 记录（TO-DO/DONE） | P0 |
| **记忆层** | Profile 存储 | P0 |
| **推演** | 基础因子交互分析 | P1 |
| **LLM 叙事** | 版本描述生成 | P1 |
| **LLM 叙事** | 推演结论生成 | P1 |

### ⏳ MVP 后续版本

| 模块 | 功能 | 阶段 |
|------|------|------|
| **命理计算** | 占星宫位（需精确出生时间） | Phase 2 |
| **命理计算** | 紫微斗数 | Phase 3 |
| **Dream Journal** | 梦境记录与解析 | Phase 2 |
| **Playbook** | 多时间粒度 Playbook | Phase 2 |
| **记忆层** | Insight 层自动提取 | Phase 2 |
| **典籍集成** | LLM 引用典籍原文 | Phase 3 |

### ❌ 不在任何版本

| 功能 | 原因 |
|------|------|
| 用户无限制对话 | 成本不可控 |
| 投资/健康强推荐 | 法律风险 |
| 社交功能 | 隐私敏感 |

---

## 用户流程（MVP）

```
1. 注册 → 输入出生信息
          ↓
2. 命理计算 → 八字 + 占星因子
          ↓
3. Profile 初始化 → 存储本命因子
          ↓
4. 版本生成 → 展示 2-3 个人生版本
          ↓
5. 用户选择 → 记录到版本树
          ↓
6. 日常使用：
   - 记录 TO-DO/DONE
   - 查看版本树
   - 请求推演分析
          ↓
7. 周期性：
   - 新版本生成（基于积累的 Event）
   - 版本树分叉
```

---

## 技术边界

### 必须复用的现有代码

| 模块 | 来源 | 说明 |
|------|------|------|
| 八字计算 | `backend/calculators/bazi/` | 核心计算逻辑 |
| 占星计算 | 如已有则复用 | 或引入新库 |
| 记忆层服务 | `backend/services/memory/` | 三层模型 |
| 版本树服务 | `backend/services/version_tree/` | 树结构管理 |
| LLM 客户端 | `backend/core/llm/client.py` | API 调用 |

### 简化或重写的部分

| 模块 | 原因 |
|------|------|
| LLM Orchestrator | 移除 TOON/典籍依赖，简化为直接 Prompt |
| 版本生成器 | 调整为双体系因子输入 |
| API 路由 | 精简为 LV 相关端点 |

### 新增部分

| 模块 | 说明 |
|------|------|
| 双体系融合逻辑 | 八字 + 占星因子融合 |
| 推演分析引擎 | 因子交互分析 |
| 前端 MVP | 版本选择 + 版本树可视化 |

---

## 数据库设计（MVP）

### PostgreSQL 表

```sql
-- 用户
users (id, email, created_at)

-- 命理因子（JSON 存储）
user_destiny_profiles (
    user_id,
    bazi_factors JSONB,      -- 八字因子
    astro_factors JSONB,     -- 占星因子
    created_at, updated_at
)

-- 版本树
version_trees (
    tree_id, user_id, root_node_id, current_node_id,
    domain, created_at, updated_at
)

-- 树节点
tree_nodes (
    node_id, tree_id, parent_id, version_id,
    decision_point, selected_option, decision_time
)

-- 事件记录
memory_events (
    event_id, user_id, kind, payload_encrypted,
    privacy_level, created_at
)
```

---

## 工作量估算

| 模块 | 人天 |
|------|------|
| 项目脚手架 | 0.5 |
| 命理计算迁移/集成 | 2 |
| 版本生成器改造 | 2 |
| 版本树服务迁移 | 1 |
| 记忆层服务迁移 | 1 |
| LLM 叙事简化 | 1 |
| API 层 | 1 |
| 数据库配置 | 0.5 |
| 前端 MVP | 3 |
| 测试与调试 | 2 |
| **总计** | **~14 人天** |

---

## 验收标准

### 功能验收

- [ ] 用户可完成注册并输入出生信息
- [ ] 系统正确计算八字和占星因子
- [ ] 用户可看到 2-3 个版本选项并对比
- [ ] 用户选择后版本树正确更新
- [ ] 用户可记录 TO-DO/DONE
- [ ] 推演分析可返回因子交互解释

### 性能验收

- [ ] 命理计算 < 2 秒
- [ ] 版本生成 < 5 秒（含 LLM）
- [ ] API 响应 P95 < 500ms（非 LLM 端点）

### 安全验收

- [ ] 敏感数据加密存储
- [ ] 用户只能访问自己的数据
